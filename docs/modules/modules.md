# Документация по модулям RusToK

Этот документ описывает **текущую** модульную структуру RusToK: какие модули
действительно подключаются в сервере, какие crates отвечают за доменные
функции, а какие — за инфраструктуру. Данные взяты из текущей реализации
workspace и кодовой регистрации модулей в `apps/server`.

## 1. Общая картина

RusToK — это модульный монолит: модули собираются в единый бинарник, но
выполняют изолированные обязанности и связываются через общий event-transport.
На уровне приложения **модули регистрируются в модульном реестре** и дальше
могут включаться/выключаться на уровне tenant-а.

Для гибкости состава модулей используется **манифест сборки** и процесс
пересборки в стиле WordPress/NodeBB: админка меняет список модулей, запускает
rebuild, после чего появляется новый бинарник с нужным набором модулей.

**Где смотреть:**
- Реестр модулей поднимается в `apps/server/src/modules/mod.rs`.
- Контракт модулей и registry находится в `crates/rustok-core`.
- Манифест модулей: `docs/modules/module-manifest.md`.
- План внедрения rebuild‑подхода: `docs/modules/module-rebuild-plan.md`.
- Marketplace модулей (каталог модулей) описан в `docs/modules/module-rebuild-plan.md`.

## 2. Модули, зарегистрированные в сервере (реальная сборка)

На данный момент **в реестр сервера добавлены следующие доменные модули**:

| Модуль | Crate | Назначение | Комментарий |
| --- | --- | --- | --- |
| Content | `rustok-content` | Базовый CMS-контент: nodes/bodies/categories/tags. | Базовый слой для контента, используется другими модулями. |
| Commerce | `rustok-commerce` | Товары, варианты, цены, заказы и склад. | Доменный e-commerce. |
| Blog | `rustok-blog` | Блог-надстройка поверх контентного ядра. | Не хранит свои таблицы. |
| Forum | `rustok-forum` | Форумные сущности (категории/темы/ответы). | Использует `rustok-content` как storage слой. |
| Pages | `rustok-pages` | Логика страниц и меню. | Лёгкий доменный модуль. |

> Эти модули реально присутствуют в сборке, потому что добавляются в
> `ModuleRegistry` внутри `apps/server`.

## 2.1 Манифест модулей (WordPress/NodeBB-style)

Чтобы не держать “жёсткий” список модулей в коде, используется отдельный
**манифест модулей**, который фиксирует состав сборки и источники модулей
(crates.io/git/path). Изменение манифеста инициирует rebuild.

Схема и формат описаны в: `docs/modules/module-manifest.md` (включая blueprint
API для admin rebuild, пайплайн сборки и rollback).

## 2.2 Install/Uninstall через rebuild

1. Админка изменяет манифест (install/uninstall).
2. Build-service пересобирает сервер.
3. Новый бинарник развёрнут.
4. Модули доступны/недоступны в `ModuleRegistry`, а включение на tenant-е
   контролируется через `tenant_modules`.

## 3. Доменные crates и их ответственность

Ниже — описание **доменных crates**, которые реализуют бизнес-логику платформы.

### 3.1 `rustok-content`
- **Роль:** базовый контентный модуль (CMS): страницы, посты, категории, теги, тела.
- **Что делает:** CRUD + события; даёт сервисы для контента.
- **Ключевые части:** `entities/`, `services/`, `dto/`.

### 3.2 `rustok-commerce`
- **Роль:** e-commerce модуль (товары, варианты, цены, заказы, склад).
- **Что делает:** управление каталогом и заказами; публикация событий.
- **Ключевые части:** `entities/`, `services/`, `dto/`.

### 3.3 `rustok-blog`
- **Роль:** блоговая надстройка над `rustok-content`.
- **Что делает:** добавляет блоговую бизнес-логику и события.
- **Особенность:** не имеет собственных таблиц.

### 3.4 `rustok-forum`
- **Роль:** форумный модуль (категории, темы, ответы, модерация).
- **Что делает:** использует `rustok-content` как storage, обеспечивает локализацию.
- **Ключевые части:** `constants.rs`, `dto/`, `services/`, `entities/`.

### 3.5 `rustok-pages`
- **Роль:** страницы и меню.
- **Что делает:** доменная логика страниц для сайтов/витрин.

### 3.6 `rustok-index`
- **Роль:** CQRS/read-model модуль (денормализованные индексы).
- **Что делает:** слушает доменные события и строит индексные таблицы.
- **Триггеры:** `ProductCreated/Updated/Deleted`, `Variant*`, `InventoryUpdated`, `PriceUpdated`.

## 4. Инфраструктурные crates

### 4.1 `rustok-core`
- **Роль:** фундамент платформы — события, registry модулей, базовые типы.
- **Что делает:** контракт `RusToKModule`, event transport, генерация ID.

### 4.2 `rustok-outbox`
- **Роль:** L1 транспорт событий на базе БД (`sys_events`).
- **Что делает:** outbox-паттерн + фоновая доставка.

### 4.3 `rustok-iggy`
- **Роль:** L2 транспорт событий (стриминг + replay) через Iggy.
- **Что делает:** автотопология потоков, партиционирование по tenant.

### 4.3.1 `rustok-iggy-connector`
- **Роль:** connector-слой для Iggy (embedded/remote).
- **Что делает:** переключает режимы и является точкой интеграции SDK/embedded runtime.

### 4.4 `rustok-tenant`
- **Роль:** мульти-тенантная метаинформация и helpers.

### 4.5 `rustok-rbac`
- **Роль:** роли и права доступа.

### 4.6 `rustok-telemetry`
- **Роль:** логирование и метрики.
- **Что делает:** инициализирует tracing subscriber, предоставляет handles для метрик.

### 4.7 `rustok-mcp`
- **Роль:** MCP-адаптер на базе `rmcp`.
- **Что делает:** подключает инструменты/ресурсы платформы к MCP.

### 4.8 `alloy-scripting`
- **Роль:** скриптовый движок Alloy (Rhai), триггеры, хранилище скриптов.
- **Что делает:** выполняет скрипты по событиям/cron/manual/API, управляет статусами и метаданными скриптов.

## 5. Приложения (apps/*)

### 5.1 `apps/server`
- **Роль:** главный API-сервер (Loco.rs).
- **Что делает:** маршрутизация, GraphQL/REST, регистрация модулей.

### 5.2 `apps/admin`
- **Роль:** админ-панель (Leptos CSR).

### 5.3 `apps/next-admin`
- **Роль:** админ-панель (Next.js App Router), альтернативный UI-слой для фронтенда.

### 5.4 `apps/storefront`
- **Роль:** публичная витрина (Leptos SSR).

### 5.5 `apps/next-frontend`
- **Роль:** публичная витрина (Next.js App Router), альтернативный UI-слой для фронтенда.

### 5.6 `apps/mcp`
- **Роль:** MCP-адаптер (stdio сервер), использует `rustok-mcp`.

## 6. Связанные документы

- Архитектура: `docs/architecture.md`
- Реестр модулей: `docs/modules/module-registry.md`
- Манифест модулей: `docs/modules/module-manifest.md`
- MCP: `docs/mcp.md`

## 7. Как работают модули (подробно)

### 7.1 Сборка и регистрация

- Модули компилируются в бинарник.
- При старте приложения формируется `ModuleRegistry`, куда попадают только
  модули, включённые в сборку.

### 7.2 Включение/выключение на tenant-е

- Факт включения хранится в таблице `tenant_modules`.
- GraphQL `toggle_module` меняет статус и вызывает хуки `on_enable/on_disable`.

### 7.3 Зависимости

- Модуль может объявить зависимости через `dependencies()`.
- При включении проверяется, что все зависимости уже включены.
- При выключении блокируется отключение, если есть зависимые модули.

### 7.4 Hooks и настройки

- `on_enable`/`on_disable` вызываются после изменения статуса в БД.
- В `ModuleContext` передаются `db`, `tenant_id` и `settings`.
- Настройки модуля хранатся в `tenant_modules.settings`.

### 7.5 Доступ к маршрутам

- Контроллеры, связанные с модулем, должны использовать guard
  `RequireModule<SLUG>`, чтобы блокировать доступ, если модуль выключен.

### 7.6 Миграции

- Модуль объявляет миграции через `MigrationSource`.
- Registry собирает список миграций для запуска в рамках общей миграции.

This is an alpha version and requires clarification. Be careful, there may be errors in the text. So that no one thinks that this is an immutable rule.
